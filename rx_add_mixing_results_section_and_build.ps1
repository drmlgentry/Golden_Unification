# ============================================================
# RX: Add CKM/PMNS Results section (auto-include shared blocks)
# ============================================================

$root = "C:\Users\Your Name Here\Desktop\Golden_Unification"
$papers = Join-Path $root "papers"
$sections = Join-Path $papers "sections"
$core = Join-Path $papers "CORE_MASTER.tex"

$secFile = Join-Path $sections "06b_mixing_results.tex"

# Sanity check: the results block you generated must exist
$block1 = Join-Path $root "shared\paperV_mixing_results.tex"
if (-not (Test-Path -LiteralPath $block1)) {
    Write-Host "Missing required file:" -ForegroundColor Red
    Write-Host "  $block1" -ForegroundColor Red
    Write-Host "Run: python .\code\verify_mixing.py --out-tex ..\shared\paperV_mixing_results.tex" -ForegroundColor Yellow
    exit 1
}

# --- write section file ---
$tex = @"
\section{Numerical CKM/PMNS verification results}
\label{sec:mixing_results}

This section records the fixed numerical outputs of the scan-and-match protocol
defined in Sec.~\ref{sec:formal_verification}. The values below are generated
by the repository verification script and exported as a LaTeX block to ensure
auditability.

\subsection{Quark sector (CKM)}

\input{../shared/paperV_mixing_results.tex}

\subsection{Lepton sector (PMNS)}

The PMNS scan is performed with the leptonic $(s_{12},s_{23},s_{13})$ and the
specified leptonic $\theta_\star$. The exported block above includes the
resulting $\delta_{\mathrm{PMNS}}$ and $J_{\mathrm{PMNS}}$.

\paragraph{Reproducibility.}
The outputs in this section are regenerated by running:
\texttt{python .\textbackslash code\textbackslash verify\_mixing.py}
with the same inputs recorded in the exported block.
"@

$tex | Set-Content -Path $secFile -Encoding UTF8
Write-Host "Wrote file: $secFile" -ForegroundColor Green

# --- insert into CORE_MASTER.tex if not present ---
$coreText = Get-Content $core -Raw
$insert = "\input{sections/06b_mixing_results.tex}"

if ($coreText -notmatch "06b_mixing_results") {
    # Insert right after the formal verification section (or after 06a if present)
    if ($coreText -match "06a_formal_verification") {
        $coreText = $coreText -replace
            "(\\input\{sections/06a_formal_verification\.tex\})",
            "`$1`n$insert"
    } else {
        $coreText = $coreText -replace
            "(\\input\{sections/06_holonomy_mixing\.tex\})",
            "`$1`n$insert"
    }
    Set-Content -Path $core -Value $coreText -Encoding UTF8
    Write-Host "Inserted results section into CORE_MASTER.tex" -ForegroundColor Green
} else {
    Write-Host "Results section already present." -ForegroundColor DarkGray
}

# --- rebuild ---
Write-Host "Compiling CORE_MASTER.tex..." -ForegroundColor Cyan
pdflatex -interaction=nonstopmode -output-directory $papers $core | Out-Null
Write-Host "Build OK: papers\CORE_MASTER.pdf" -ForegroundColor Cyan
